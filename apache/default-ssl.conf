<VirtualHost *:443>
    ServerName localhost

    SSLEngine on
    SSLCertificateFile "/usr/local/apache2/conf/ssl/nginx-selfsigned.crt"
    SSLCertificateKeyFile "/usr/local/apache2/conf/ssl/nginx-selfsigned.key"

    # Strong SSL settings
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE+AESGCM:ECDHE+AES256:!aNULL:!MD5:!3DES
    SSLHonorCipherOrder on

    # Enable HTTP Strict Transport Security (HSTS)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Proxy to Node.js app
    ProxyPreserveHost On
    ProxyPass / http://galleryapp:3000/
    ProxyPassReverse / http://galleryapp:3000/

    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>

<VirtualHost *:80>
    ServerName localhost

    RewriteEngine On
    # Redirect HTTP to HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

    # Proxy to Node.js app
    ProxyPreserveHost On
    ProxyPass / http://galleryapp:3000/
    ProxyPassReverse / http://galleryapp:3000/

    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>

# Load modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule alias_module modules/mod_alias.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule ssl_module modules/mod_ssl.so

Listen 80
Listen 443

DocumentRoot "/usr/local/apache2/htdocs"
<Directory "/usr/local/apache2/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

ErrorLog /proc/self/fd/2
CustomLog /proc/self/fd/1 common
